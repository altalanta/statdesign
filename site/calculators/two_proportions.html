<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Sample Proportion Calculator</title>
    <style>
        .calculator {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #005a87;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .row {
            display: flex;
            gap: 15px;
        }
        .col {
            flex: 1;
        }
        .formula-note {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <h2>Two-Sample Proportion Sample Size Calculator</h2>
        <p>Calculate the required sample size for comparing two proportions using normal approximation.</p>
        
        <form id="calculatorForm">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="p1">Proportion 1 (p₁):</label>
                        <input type="number" id="p1" step="0.01" min="0" max="1" value="0.6" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="p2">Proportion 2 (p₂):</label>
                        <input type="number" id="p2" step="0.01" min="0" max="1" value="0.5" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="alpha">Alpha (α):</label>
                        <input type="number" id="alpha" step="0.01" min="0.001" max="0.5" value="0.05" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="power">Power (1-β):</label>
                        <input type="number" id="power" step="0.01" min="0.01" max="0.99" value="0.8" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="ratio">Allocation Ratio (n₂/n₁):</label>
                        <input type="number" id="ratio" step="0.1" min="0.1" value="1.0" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="tail">Alternative Hypothesis:</label>
                        <select id="tail" required>
                            <option value="two-sided">Two-sided</option>
                            <option value="greater">Greater (p₁ > p₂)</option>
                            <option value="less">Less (p₁ < p₂)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button type="submit">Calculate Sample Size</button>
        </form>
        
        <div id="result" class="result">
            <h3>Results</h3>
            <div id="resultContent"></div>
        </div>
        
        <div class="formula-note">
            <strong>Note:</strong> This calculator uses the normal approximation method with continuity correction.
            Effect size (h) = 2 × [arcsin(√p₁) - arcsin(√p₂)]
        </div>
    </div>

    <script>
        // Normal distribution quantile function (approximation)
        function normalInverse(p) {
            const a1 = -3.969683028665376e+01;
            const a2 = 2.209460984245205e+02;
            const a3 = -2.759285104469687e+02;
            const a4 = 1.383577518672690e+02;
            const a5 = -3.066479806614716e+01;
            const a6 = 2.506628277459239e+00;
            
            const b1 = -5.447609879822406e+01;
            const b2 = 1.615858368580409e+02;
            const b3 = -1.556989798598866e+02;
            const b4 = 6.680131188771972e+01;
            const b5 = -1.328068155288572e+01;
            
            const c1 = -7.784894002430293e-03;
            const c2 = -3.223964580411365e-01;
            const c3 = -2.400758277161838e+00;
            const c4 = -2.549732539343734e+00;
            const c5 = 4.374664141464968e+00;
            const c6 = 2.938163982698783e+00;
            
            const d1 = 7.784695709041462e-03;
            const d2 = 3.224671290700398e-01;
            const d3 = 2.445134137142996e+00;
            const d4 = 3.754408661907416e+00;
            
            if (p <= 0 || p >= 1) return NaN;
            
            const q = p - 0.5;
            
            if (Math.abs(q) <= 0.425) {
                const r = 0.180625 - q * q;
                return q * (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) /
                       (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            }
            
            const r = q < 0 ? p : 1 - p;
            const t = Math.sqrt(-Math.log(r));
            
            let result;
            if (t <= 5) {
                result = (((((c1 * t + c2) * t + c3) * t + c4) * t + c5) * t + c6) /
                        ((((d1 * t + d2) * t + d3) * t + d4) * t + 1);
            } else {
                result = (((((c1 * t + c2) * t + c3) * t + c4) * t + c5) * t + c6) /
                        ((((d1 * t + d2) * t + d3) * t + d4) * t + 1);
            }
            
            return q < 0 ? -result : result;
        }
        
        function calculateTwoProportions(p1, p2, alpha, power, ratio, tail) {
            // Input validation
            if (p1 <= 0 || p1 >= 1 || p2 <= 0 || p2 >= 1) {
                throw new Error("Proportions must be between 0 and 1 (exclusive)");
            }
            if (alpha <= 0 || alpha >= 1) {
                throw new Error("Alpha must be between 0 and 1 (exclusive)");
            }
            if (power <= 0 || power >= 1) {
                throw new Error("Power must be between 0 and 1 (exclusive)");
            }
            if (ratio <= 0) {
                throw new Error("Ratio must be positive");
            }
            
            // Critical values
            let z_alpha;
            if (tail === "two-sided") {
                z_alpha = normalInverse(1 - alpha / 2);
            } else {
                z_alpha = normalInverse(1 - alpha);
            }
            const z_beta = normalInverse(power);
            
            // Effect size calculation using arcsin transformation
            const h = 2 * (Math.asin(Math.sqrt(p1)) - Math.asin(Math.sqrt(p2)));
            
            // Sample size calculation
            const numerator = Math.pow(z_alpha + z_beta, 2);
            const denominator = Math.pow(h, 2);
            
            const n_base = 4 * numerator / denominator;
            
            // Adjust for allocation ratio
            const n1 = Math.ceil(n_base * (1 + ratio) / Math.pow(1 + Math.sqrt(ratio), 2));
            const n2 = Math.ceil(n1 * ratio);
            
            return {
                n1: n1,
                n2: n2,
                effect_size_h: h,
                total_n: n1 + n2
            };
        }
        
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const p1 = parseFloat(document.getElementById('p1').value);
            const p2 = parseFloat(document.getElementById('p2').value);
            const alpha = parseFloat(document.getElementById('alpha').value);
            const power = parseFloat(document.getElementById('power').value);
            const ratio = parseFloat(document.getElementById('ratio').value);
            const tail = document.getElementById('tail').value;
            
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            try {
                const result = calculateTwoProportions(p1, p2, alpha, power, ratio, tail);
                
                resultContent.innerHTML = `
                    <h4>Sample Size Results</h4>
                    <p><strong>Group 1 (n₁):</strong> ${result.n1} subjects</p>
                    <p><strong>Group 2 (n₂):</strong> ${result.n2} subjects</p>
                    <p><strong>Total Sample Size:</strong> ${result.total_n} subjects</p>
                    <p><strong>Effect Size (h):</strong> ${result.effect_size_h.toFixed(4)}</p>
                    <p><strong>Difference in Proportions:</strong> ${Math.abs(p1 - p2).toFixed(3)}</p>
                    
                    <h4>Input Parameters</h4>
                    <p>p₁ = ${p1}, p₂ = ${p2}, α = ${alpha}, Power = ${power}</p>
                    <p>Allocation ratio = ${ratio}, Alternative = ${tail}</p>
                `;
                
                resultDiv.className = 'result success';
                resultDiv.style.display = 'block';
            } catch (error) {
                resultContent.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
            }
        });
        
        // Calculate on page load with default values
        document.getElementById('calculatorForm').dispatchEvent(new Event('submit'));
    </script>
</body>
</html>